<!doctype html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title>Traveller</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- <link rel="stylesheet" href=""> -->
	<meta property="og:title" content="Fiast MC-3a" />
	<meta property="og:image" content="https://www.gravatar.com/avatar/21621c02d6a6ab7b07b4a6982b6ec68e.jpg?s=300" />
	<meta property="og:type" content="website" />
	<meta property="og:description" content="HTML5 reimplementation of infamous chinese synthetiser" />

	
<style>
/* CSS Grid */

.dp20,
.dp25,
.dp33,
.dp50,
.dp100{float:left; display: inline; *margin-left:-0.04em; } /* IE margin hack */

/* dp = div percet */

.dp20{width:20%;}
.dp25{width:25%;}
.dp33{width:33.33%;}
.dp50{width:50%;}
.dp100{width:100%;}
/*.clear{ clear:both;}*/

/* here comes the magic - natural (old IE) style box model */

.dp20, .dp25, .dp33, .dp50, .dp100, .natural {
-webkit-box-sizing: border-box; /* Safari/Chrome, other WebKit */
-moz-box-sizing: border-box;    /* Firefox, other Gecko */
box-sizing: border-box;         /* Opera/IE 8+ */
}

/* here comes clearfix from bootstrap */
.dprow {
  *zoom: 1;
}

.dprow:before,
.dprow:after {
  display: table;
  line-height: 0;
  content: "";
}

.dprow:after {
  clear: both;
}

.wrap {
	display: block;
	width: 600px;
	padding: 10px;
	margin: 0 auto;
	background-color: #222;
	color: #ddd;
	font-family: monospace;
}

.wrap button, .wrap select, .wrap input {
	background-color: #222;
	color: #ddd;
	border: 1px solid #ddd;
	border-radius: 3px;
	margin: 2px;
	padding: 2px;
	font-family: monospace;
}

.wrap button[disabled=disabled] {
	color: #333;
}

.wrap input[type=range] {
	width: 80%;
}

</style>
<script src="js/uboot.js"></script>
<script src="js/JZZ.js"></script>
<script src="js/JZZ.input.Kbd.js"></script>
<script src="js/JZZ.gui.Select.js"></script>
<script src="js/JZZ.synth.Severak.js"></script>


</head>
<body>

<div class="wrap">
<div class="dprow">
<button id="power">‚èª (power)</button>
</div>
<div class="dprow">
<div class="dp50">

<div class="dprow">
<div class="dp50">
vol <input type="range" min="0" max="1" step="0.1" value="0.5" id="vol">
</div>
<div class="dp50">
<select id="wave">
<option name="triangle">triangle</option>
<option name="square">square</option>
<option name="sawtooth">sawtooth</option>
<option name="arp" disabled>arp</option>
<option name="pwm" disabled>pwm</option>
<option name="noise" disabled>noise</option>
<option name="tonal noise" disabled>tonal noise</option>
</select>
</div>
</div>
<div class="dprow">
<div class="dp33">
<label><input type="checkbox" id="hold"> hold</label>
</div>
<div class="dp33">
<label><input type="checkbox" id="bite"> bite</label>
</div>
<div class="dp33">
<label><input type="checkbox" id="quack"> quack</label>
</div>
</div>
<div class="dprow">
TRAVELLER
</div>

</div>
<div class="dp50">

<div class="dprow">
<div class="dp50">
<input type="range" min="0.01" max="1" step="0.1" value="0.2" id="attack">
</div>
<div class="dp50">
<input type="range" min="0.01" max="1" step="0.1" value="0.5" id="decay">

</div>
</div>

</div>
</div>
<div class="dprow">
<input type="range" min="0" max="22000" value="22000" id="traveller">
</div>

<div class="dprow">
<div id="keyboard"></div>
</div>
<div class="dprow">
MIDI input: <select id="select_midi_in"></select> | <button id="record">record</button>
</div>
</div>


<script>

var kbd = JZZ.input.Kbd({ at:'keyboard', pos:'N', wl: 50, ww:21, bl: 25, bw:12, from:'F4', to:'C7' });

var midiIn = JZZ.gui.SelectMidiIn({ at: 'select_midi_in' });

midiIn.onSelect = function(name) {
  console.log('MIDI-In selected:', name);
 midiIn.connect(kbd);
};

function clamp(min, v, max) {
	if (v < min) return min;
	if (v > max) return max;
	return v;
}

function midi2cps(midi) {
	var A4 = 440;
	return A4 * Math.pow(2, (midi - 69) / 12);
}

function cps2midi(cps)
{
	var A4 = 440;
	return 69 + 12 * Math.log2(cps / A4);
}

/*
var bufferSize = 2 * audioContext.sampleRate,
    noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate),
    output = noiseBuffer.getChannelData(0);
for (var i = 0; i < bufferSize; i++) {
    output[i] = Math.random() * 2 - 1;
}

var whiteNoise = audioContext.createBufferSource();
whiteNoise.buffer = noiseBuffer;
whiteNoise.loop = true;
whiteNoise.start(0);
*/

function Traveller(ac) {
	var me = {};
	me.vol = 0.25;
	me.wave = 'sawtooth';
	me.attack = 0.5;
	me.decay = 0.5;
	me.hold = true;
	me.bite = false;
	me.quack = false;
	me.traveller = 22000;
	
	me._ac = ac;
	
	me._osc = me._ac.createOscillator();
	me._osc.type = me.wave;
	me._osc.frequency.setValueAtTime(440, me._ac.currentTime);
	me._osc.start();
	
	me._vcf = me._ac.createBiquadFilter();
	me._vcf.type = 'lowpass';
	
	me._vca = me._ac.createGain();
	me._vca.gain.setValueAtTime(0, me._ac.currentTime);
	
	me._osc.connect(me._vca);
	// me._vcf.connect(me._vca);
	me._vca.connect(me._ac.destination); // TODO - output
	
	me.noteOn = function(nn) {
		var freq = midi2cps(nn);
		
		console.log("ON", me, nn);
		
		// stop envelope movement
		me._vca.gain.cancelScheduledValues(me._ac.currentTime);
		
		
		me._vca.gain.setValueAtTime(0, me._ac.currentTime);
		
		// VCA up 
		me._vca.gain.linearRampToValueAtTime(me.vol, me._ac.currentTime + me.attack + 0.01);
		console.log("VCA up", me.vol, me._ac.currentTime + me.attack + 0.01, me._ac.currentTime);
		
		// VCF up
		if (me.quack) {
			me._vcf.frequency.linearRampToValueAtTime(0, me._ac.currentTime + me.attack + 0.01);
			me._vcf.frequency.linearRampToValueAtTime(me.traveller, me._ac.currentTime + me.attack);
		} else {
			me._vcf.frequency.cancelScheduledValues(me._ac.currentTime);
			me._vcf.frequency.setValueAtTime(me.traveller, me._ac.currentTime + 0.01);
		}
		
		
		// switch OSC
		me._osc.type = me.wave;
		me._osc.frequency.setValueAtTime(freq, me._ac.currentTime); // TODO - portamento
		
		// TODO VCF
		
		if (!me.hold) {
			// VCA down
			me._vca.gain.linearRampToValueAtTime(0, me._ac.currentTime + me.attack + me.decay);
			if (me.quack) {
				me._vcf.frequency.linearRampToValueAtTime(0, me._ac.currentTime + me.attack + me.decay);
			}
		}
	};
	
	me.noteOff = function(nn) {
		console.log("OFF", me, nn);
		if (me.hold) {
			// me._vca.gain.cancelScheduledValues(me._ac.currentTime);
			// VCA down
			me._vca.gain.linearRampToValueAtTime(0, me._ac.currentTime + me.decay);
			
			console.log("VCA down", me.vol, me._ac.currentTime + me.attack + 0.01, me._ac.currentTime);
			
			if (me.quack) {
				me._vcf.frequency.linearRampToValueAtTime(0, me._ac.currentTime + me.decay);
			}
		}
	};
	
	me.panic = function() {
		// me._vca.gain.setValueAtTime(0, me._ac.currentTime);
	};
	
	
	
	return me;
}

function chnget(synth, param) {
	if (ub.gebi(param).tagName=="SELECT") {
		// select -> string
		ub.on(param, 'change', function(){
			synth[param] = ub.gebi(param).value;
		});
	} else if (ub.gebi(param).getAttribute("type")=="checkbox") {
		// checkbox -> bool
		ub.on(param, 'change', function(){
			synth[param] = ub.gebi(param).checked;
		});
	} else {
		// numeric
		ub.on(param, 'change', function(){
			synth[param] = ub.tonumber(ub.gebi(param).value);
		});
	}
}

ub.on("power","click",  function(){
	var AudioContext = window.AudioContext || window.webkitAudioContext;
	var ac= new AudioContext();
	
	window.traveller = Traveller(ac);
	traveller.noteOn(60);
	setTimeout(function() {traveller.noteOff(0);}, 500);
	
	chnget(traveller, "vol");
	chnget(traveller, "wave");
	chnget(traveller, "attack");
	chnget(traveller, "decay");
	chnget(traveller, "hold");
	chnget(traveller, "bite");
	chnget(traveller, "quack");
	chnget(traveller, "traveller");
	
	wrap = JZZ.synth.Severak();
	wrap.setSynth(traveller);
	kbd.connect(wrap);
	
});
</script>

</body>
</html>