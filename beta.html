<!doctype html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title>Cyber Music Studio (beta)</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Severák's Cyber Music Studio" />
	<meta property="og:image" content="https://severak.github.io/cyber-music-studio/img/preview.png" />
	<meta property="og:type" content="website" />
	<meta property="og:description" content="not your usual DAW" />
	<link rel="stylesheet" href="css/uboot.css">
    <link rel="stylesheet" href="css/gh-fork-ribbon.css">
    <script src="js/bluescreen.js"></script>
    <script src="js/uboot.js"></script>
<script src="js/JZZ.js"></script>
<script src="js/JZZ.input.Kbd.js"></script>
<script src="js/JZZ.gui.Select.js"></script>
<script src="js/wavy-jones.js"></script>
<script src="js/heartbeat.js"></script>
<style>
body {
	font-family: "Lucida Console", monospace;
	background-color: plum;
}

.ub-box {
	background-color: lightyellow;
}

a { color: black; text-decoration-style: dashed; text-decoration-thickness: 1px; }

#scope {
	padding: 0;
    width: 100%;
	height: 80px;
	background-color: #000;
}
</style>
</head>
<body>

<a class="github-fork-ribbon" href="https://github.com/severak/cyber-music-studio" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>

<div class="ub-container">
<h1>Cyber Music Studio™ <small>beta</small></h1>

<form class="ub-form" id="form">

<div class="ub-box" id="box_welcome">
<img src="img/preview.png" class="ub-fit-img">
<p>This is beta version of Cyber Music Studio™. It's not finished yet and can be broken at any moment.</p>
<p>Feel free to test it and report bugs <a href="https://github.com/severak/cyber-music-studio/issues" target="_blank">here</a>.</p>
<center><button id="power"><big>OK</big></button></center>
</div>
<br><br>

<div class="ub-box ub-hidden" id="box_traveller" style="background-color: silver">

<div class="ub-cols">
<div class="ub-same">
<h2>traveller</h2>
</div>
<div style="text-align: right;" class="ub-same">
<small>flexible monosynth</small>
</div>
</div>


<div class="ub-cols">
    <div class="ub-same">
        LFO
        <select id="lfo">
            <option name="sine">sine</option>
            <option name="triangle">triangle</option>
            <option name="square">square</option>
            <option name="sawtooth" selected>sawtooth</option>
        </select>
    </div>
    <div class="ub-same">
        rate <input type="range" min="0.30" max="30" step="0.25" value="5" id="rate">
    </div>
    <div class="ub-same">
        amp <input type="range" min="0" max="1" step="0.01" value="0" id="amp">
    </div>
    <div class="ub-same">
        vcf <input type="range" min="0" max="1" step="0.01" value="0" id="detune">
    </div>
</div>

<div class="ub-cols">
<div class="ub-same">
vol <input type="range" min="0" max="0.5" step="0.01" value="0.25" id="vol">
</div>
<div class="ub-same">
waveform:
<select id="wave">
<option name="sine">sine</option>
<option name="triangle">triangle</option>
<option name="square">square</option>
<option name="sawtooth" selected>sawtooth</option>
<option name="arp" disabled>arp</option>
<option name="pwm" disabled>pwm</option>
<option name="noise" disabled>noise</option>
<option name="tonal noise" disabled>tonal noise</option>
</select>
</div>
<div class="ub-same">
attack
<input type="range" min="0.01" max="1" step="0.1" value="0.2" id="attack">
</div>
<div class="ub-same">
decay
<input type="range" min="0.01" max="1" step="0.1" value="0.5" id="decay">
</div>
</div>

<div class="ub-cols">
<div class="ub-same">
    <input type="checkbox" id="hold" checked class="ub-checkbutton" ><label for="hold" class="ub-checkbutton">hold</label>
</div>
<div class="ub-same">
    <input type="checkbox" id="bite" class="ub-checkbutton"><label for="bite" class="ub-checkbutton">bite</label>
</div>
<div class="ub-same">
    <input type="checkbox" id="quack" class="ub-checkbutton"><label for="quack" class="ub-checkbutton">quack</label>
</div>
</div>

<div class="ub-cols">
<div class="ub-same">
TRAVELLER
<input type="range" min="0" max="22000" value="22000" id="traveller">
</div>
</div>

<div class="ub-cols">
<div class="ub-same"  style="text-align: center">
<div id="keyboard"></div>
</div>
</div>

<div class="ub-cols">
<div class="ub-same" style="text-align: center">
MIDI input: <select id="select_midi_in"></select> <!-- | <button id="record">record</button> -->
</div>
</div>

</div>

<br><br>

<div class="ub-box ub-hidden" style="background-color: coral" id="box_nomad">

<div class="ub-cols">
<div class="ub-same">
<h2>analog nomad</h2>
</div>
<div style="text-align: right;" class="ub-same">
<small>Juno-like polysynth</small><br>
	<input type="range" min="0" max="1" value="0.5" step="0.05" id="n_vol"> vol
</div>
</div>

<div class="ub-cols">
<div class="ub-same">
pulse <input type="range" min="0" max="0.3" step="0.1" value="0.25" id="pulse">
</div>
<div class="ub-same">
saw <input type="range" min="0" max="0.3" step="0.1" value="0.25" id="saw">
</div>
<div class="ub-same">
sub <input type="range" min="0" max="0.3" step="0.1" value="0.25" id="sub">
</div>
<div class="ub-same">
noise <input type="range" min="0" max="0.3" value="0" step="0.05" id="noise">
</div>
</div>

<div class="ub-cols">
<div class="ub-same">
A <input type="range" min="0.01" max="1" step="0.01" value="0.01" id="A">
</div>
<div class="ub-same">
D <input type="range" min="0.01" max="1" step="0.01" value="0.25" id="D">
</div>
<div class="ub-same">
S <input type="range" min="0" max="1" step="0.1" value="0.8" id="S">
</div>
<div class="ub-same">
R <input type="range" min="0.01" max="1" step="0.1" value="0.5" id="R">
</div>
</div>


<div class="ub-cols">
<div class="ub-same">
<label><input type="checkbox" id="n_quack" checked> quack</label>
</div>
<div class="ub-same">
FREQ <input type="range" min="30" max="22000" step="1" value="8000" id="n_freq">
</div>
<div class="ub-same">
Q <input type="range" min="0" max="10" step="0.1" value="5" id="n_resonance">
</div>
</div>

<div class="ub-cols">
<div class="ub-same"  style="text-align: center">
<div id="keyboard2"></div>
</div>
</div>

<div class="ub-cols">
<div class="ub-same" style="text-align: center">
MIDI input: <select id="select_midi_in2"></select> <!-- | <button id="record" disabled>record</button> -->
</div>
</div>

</div>

<br><br>
<div id="scope" class="ub-box ub-hidden"></div>

<p>part of <a href="index.html">Cyber Music Studio™</a></p>


</form>


<script>
function keyboardMidiWrap(keyboardElemId, midiSelectorId, synth) {
    // set up routing from external MIDI via HTML keyboard to synth itself
    var kbd = JZZ.input.Kbd({ at:keyboardElemId, pos:'N', wl: 50, ww:21, bl: 25, bw:12, from:'F4', to:'C7' });
    var midiIn = JZZ.gui.SelectMidiIn({ at: midiSelectorId });
    kbd.connect(function (msg) {
       hb.midi2call(msg, synth);
    });

    // handles all the selection stuff
    midiIn.onSelect = function(name) {
        JZZ().openMidiIn(name).and(function () {
            if (kbd.currentExternal) kbd.currentExternal.disconnect(kbd);
            this.connect(kbd);
            kbd.currentExternal = this;
        }).or(function () {
            if (kbd.currentExternal) kbd.currentExternal.disconnect(kbd);
        });
    };
}

// Traveller
// simple monophonic synth:
// OSC -> VCF -> VCA
hb.Traveller = function(out) {
    var me = {};
    me.vol = 0.25;
    me.wave = 'sawtooth';
    me.attack = 0.2;
    me.decay = 0.5;
    me.hold = true;
    me.bite = false;
    me.quack = false;
    me.traveller = 22000;
    me.lfo = 'sawtooth';
    me.rate = 5;
    me.amp = 0;
    me.detune = 0;

    me._ac = hb.ac;
    if (!out) out = hb.ac;
    me._out = out;

    me._osc = hb.makeOsc(me.wave, 440);
    me._vcf = hb.makeFilter('lowpass');
    me._vca = hb.makeGain();
    me._vol = hb.makeGain(me.vol);

    me._lfo = hb.makeOsc(me.lfo, me.rate); // {-1, 1}
    me._lfoAmp = hb.makeGain(me.amp);
    me._lfoDetune = hb.makeGain(me.detune);

    var normLFO = hb.makeAdder(hb.makeMultiplier(me._lfo, 0.5), 0.5);
    hb.chain(normLFO, me._lfoAmp);
    var modF = hb.makeAdder(1, hb.makeMultiplier(me._lfoAmp, -1));
    var modulator = hb.makeGain(1);
    modF.connect(modulator.gain);

    var toCents = hb.makeGain(100);
    hb.chain(me._lfo, me._lfoDetune, toCents, me._osc.detune); // detune LFO

    hb.chain(me._osc, me._vcf, modulator, me._vca, me._vol, me._out.destination);

    me.param = function(name, val) {
        me[name] = val;

        if (!me.quack && name=='traveller') {
            me._vcf.frequency.setValueAtTime(me.traveller, me._ac.currentTime)
        }

        if (name=='vol') {
            me._vol.gain.setValueAtTime(me.vol, me._ac.currentTime)
        }

        if (name=='rate') {
            me._lfo.frequency.setValueAtTime(me.rate, me._ac.currentTime)
        }

        if (name=='amp') {
            me._lfoAmp.gain.setValueAtTime(me.amp, me._ac.currentTime)
        }

        if (name=='detune') {
            me._lfoDetune.gain.setValueAtTime(me.detune, me._ac.currentTime)
        }

        if (name=='lfo') {
            me._lfo.type = me.lfo;
        }
    };

    me.noteOn = function(nn) {
        me.lastN = nn;
        var freq = hb.midi2cps(nn);

        // switch OSC
        me._osc.type = me.wave;
        // TODO - SIN is crackling when changing freq
        hb.moveTo(me._osc.frequency, freq, hb.clamp(0.1, me.attack / 2, 1));
        hb.moveTo(me._vca.gain, 1, me.attack); // VCA ENV
        me._vcf.Q.value = me.bite ? 10 : 1;
        if (me.quack) { // VCF ENV:
            hb.moveTo(me._vcf.frequency, me.traveller, me.attack);
        } else {
            hb.setNow(me._vcf.frequency, me.traveller);
        }
    };

    me.noteOff = function(nn) {
        if (!me.hold) return;
        if (nn!=me.lastN) return;
        hb.moveTo(me._vca.gain, 0, me.decay);
        if (me.quack) {
            hb.moveTo(me._vcf.frequency, 0, me.decay);
        } else {
            hb.setNow(me._vcf.frequency, me.traveller);
        }
    };

    me.panic = function() {
        hb.setNow(me._vca.gain, 0);
    };

    return me;
};

hb.AnalogNomad = function(out) {
    var me = {};
    me.vol = 0.25;

    me.attack = 0.1;
    me.decay = 0.1;
    me.sustain = 0.8;
    me.release = 0.5;

    me.saw = 0.3;
    me.pulse = 0.2;
    me.sub = 0.1;
    me.noise = 0.1;

    // TODO - implement pulse width of PWM OSC

    me.filter = 22000;
    me.resonance = 5;
    me.quack = true;

    me._ac = hb.ac;
    if (!out) out = hb.ac;
    me._out = out;

    me._vol = hb.makeGain(me.vol)
    me._vol.connect(me._out.destination);

    // me._notes = [];
    me._voices = {};

    me.param = function(name, val) {
        me[name] = val;
        if (name=='vol') me._vol.gain.setValueAtTime(me.vol, me._ac.currentTime);
    };

    me._getEnv = function(max) {
        return {
            max: max,
            attack: me.attack,
            decay: me.decay,
            sustain: me.sustain,
            release: me.release
        };
    };

    me._getFEnv = function() {
        return {
            max: 22000,
            attack: me.attack,
            decay: me.decay,
            sustain: me.filter * me.sustain,
            release: me.release
        };
    };


    me._makeVoice = function(nn) {
        var freq = hb.midi2cps(nn);
        var vox = {};

        vox._saw = hb.makeOsc('sawtooth', freq);
        vox._pulse = hb.makeOsc('square', freq);
        vox._sub = hb.makeOsc('square', freq/2);
        vox._noise = hb.makeNoiseOsc();

        vox._saw_gain = hb.makeGain(me.saw);
        vox._pulse_gain = hb.makeGain(me.pulse);
        vox._sub_gain = hb.makeGain(me.sub);
        vox._noise_gain = hb.makeGain(me.noise);

        vox._env = hb.makeGain();

        vox._saw.connect(vox._saw_gain);
        vox._pulse.connect(vox._pulse_gain);
        vox._sub.connect(vox._sub_gain);
        vox._noise.connect(vox._noise_gain);
        vox._saw_gain.connect(vox._env);
        vox._pulse_gain.connect(vox._env);
        vox._sub_gain.connect(vox._env);
        vox._noise_gain.connect(vox._env);

        vox._filter = hb.makeFilter('lowpass');
        vox._filter.Q.setValueAtTime(me.resonance, hb.ac.currentTime);
        vox._env.connect(vox._filter);

        hb.adsrStart(vox._env.gain, me._getEnv(1));
        if (me.quack) {
            vox._filter.frequency.setValueAtTime(0, hb.ac.currentTime);
            hb.adsrStart(vox._filter.frequency, me._getFEnv());
        } else {
            vox._filter.frequency.setValueAtTime(me.filter, hb.ac.currentTime);
        }

        vox._filter.connect(me._vol);


        vox.noteOff = function () {
            var env = me._getEnv(1);
            hb.adsrStop(vox._env.gain, env);
            if (me.quack) {
                hb.adsrStop(vox._filter.frequency, me._getFEnv());
            }
            vox._saw.stop(hb.ac.currentTime + env.release);
            vox._pulse.stop(hb.ac.currentTime + env.release);
            vox._sub.stop(hb.ac.currentTime + env.release);
        };

        return vox;
    };

    me.noteOn = function(nn) {
        me._voices[nn] = me._makeVoice(nn);
    };

    me.noteOff = function(nn) {
        if (!me._voices[nn]) return; // už není
        me._voices[nn].noteOff();
        delete me._voices[nn];
    };

    me.panic = function() {

        me._vol.gain.setValueAtTime(0, me._ac.currentTime);
    };

    return me;
};

ub.on("power","click",  function(ev){
	ub.stop(ev);
	ub.addClass("box_welcome", 'ub-hidden');
	ub.delClass("box_traveller", 'ub-hidden');
	ub.delClass("box_nomad", 'ub-hidden');
	ub.delClass("scope", 'ub-hidden');

	ub.gebi('form').reset();
	hb.start();

	window.traveller = hb.Traveller();
	hb.chnget(traveller, "vol");
	hb.chnget(traveller, "wave");
	hb.chnget(traveller, "attack");
	hb.chnget(traveller, "decay");
	hb.chnget(traveller, "hold");
	hb.chnget(traveller, "bite");
	hb.chnget(traveller, "quack");
	hb.chnget(traveller, "traveller");
	hb.chnget(traveller, "lfo");
	hb.chnget(traveller, "rate");
	hb.chnget(traveller, "amp");
	hb.chnget(traveller, "detune");

	keyboardMidiWrap('keyboard', 'select_midi_in', traveller);

	window.nomad = hb.AnalogNomad();
	hb.chnget(nomad, 'vol', 'n_vol');
	hb.chnget(nomad, 'saw');
	hb.chnget(nomad, 'pulse');
	hb.chnget(nomad, 'sub');
	hb.chnget(nomad, 'noise');
	hb.chnget(nomad, 'attack', 'A');
	hb.chnget(nomad, 'decay', 'D');
	hb.chnget(nomad, 'sustain', 'S');
	hb.chnget(nomad, 'release', 'R');
	hb.chnget(nomad, 'release', 'R');
	hb.chnget(nomad, 'quack', 'n_quack');
	hb.chnget(nomad, 'filter', 'n_freq');
	hb.chnget(nomad, 'resonance', 'n_resonance');

    keyboardMidiWrap('keyboard2', 'select_midi_in2', nomad);

	var oscope = new WavyJones(hb.ac, 'scope');
	oscope.lineColor = '#00ff00';
	oscope.lineThickness = 2;
	traveller._vol.connect(oscope);
	nomad._vol.connect(oscope);
});
</script>

</div>

<script src="//million.svita.cz/millions_v1.js"></script>
</body>
</html>
