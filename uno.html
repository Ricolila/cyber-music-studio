<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UNO synth</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/uboot.css">
    <link rel="stylesheet" href="css/gh-fork-ribbon.css">
    <script src="js/bluescreen.js"></script>
    <script src="js/uboot.js"></script>
    <script src="js/JZZ.js"></script>
    <script src="js/JZZ.input.Kbd.js"></script>
    <script src="js/JZZ.gui.Select.js"></script>
    <script src="js/JZZ.synth.Severak.js"></script>
    <script src="js/wavy-jones.js"></script>
    <script src="js/heartbeat.js"></script>
    <style>
        body {
            font-family: "Lucida Console", monospace;
            background-color: plum;
        }

        .ub-box {
            background-color: lightyellow;
        }

        a { color: black; text-decoration-style: dashed; }

        #scope {
            padding: 0;
            width: 100%;
            height: 80px;
            background-color: #000;
        }

        #recording_download {
            color: black;
            text-decoration-style: dashed;
        }
    </style>
    <script>if(!sessionStorage.getItem("_swa")&&document.referrer.indexOf(location.protocol+"//"+location.host)!== 0){fetch("https://counter.dev/track?"+new URLSearchParams({referrer:document.referrer,screen:screen.width+"x"+screen.height,user:"severak",utcoffset:"1"}))};sessionStorage.setItem("_swa","1");</script>
</head>
<body>

<a class="github-fork-ribbon" href="https://github.com/severak/cyber-music-studio" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>

<div class="ub-container wrap">


    <div class="ub-box" id="box_welcome">
        <img src="img/preview.png" class="ub-fit-img">
        <p>This is part of beta version of Cyber Music Studio™. It's not finished yet and can be broken at any moment.</p>
        <p>Feel free to test it and report bugs <a href="https://github.com/severak/cyber-music-studio/issues" target="_blank">here</a>.</p>
        <center><button id="power" class="ub-button"><big>OK</big></button></center>
    </div>
    <br><br>



    <form class="ub-form ub-hidden ub-box" id="form">
        <button id="play">play</button>
        <button id="stop">stop</button>
        <input class="ub-checkbutton" id="octave_up" type="checkbox"><label class="ub-checkbutton" for="octave_up">octave up</label>
        <button id="preset" class="ub-hidden">show preset</button>

        <p>part of <a href="index.html">Cyber Music Studio™</a></p>

    </form>
</div>

<script>

    Metro = function(click) {
        var me = {};
        me._running = false;
        me._nextStep = -1;

        me.setBpm = function(bpm, div) {
            div = div || 4;
            me._stepTime = 60 / (bpm * div);
        };

        me.start = function () {
            if (me._running) {
                return;
            }
            me._running = true;
            me._nextStep = hb.ac.currentTime;
            me.tick();
        };

        me.stop = function () {
            me._running = false;
        };

        me.tick = function () {
            if (hb.ac.currentTime >= me._nextStep) {
                click();
                me._nextStep = hb.ac.currentTime + me._stepTime;
            }
            if (me._running) {
                setTimeout(me.tick, 1);
            }
        };

        me.setBpm(120);
        return me;
    };
    /*

    from https://webmidijs.org/docs/v2.5.2/files/src_webmidi.js.html#l1923

          noteoff: 0x8,           // 8
          noteon: 0x9,            // 9
          keyaftertouch: 0xA,     // 10
          controlchange: 0xB,     // 11
          channelmode: 0xB,       // 11
          nrpn: 0xB,              // 11
          programchange: 0xC,     // 12
          channelaftertouch: 0xD, // 13
          pitchbend: 0xE          // 14


          // System common messages
          sysex: 0xF0,            // 240
          timecode: 0xF1,         // 241
          songposition: 0xF2,     // 242
          songselect: 0xF3,       // 243
          tuningrequest: 0xF6,    // 246
          sysexend: 0xF7,         // 247 (never actually received - simply ends a sysex)

          // System real-time messages
          clock: 0xF8,            // 248
          start: 0xFA,            // 250
          continue: 0xFB,         // 251
          stop: 0xFC,             // 252
          activesensing: 0xFE,    // 254
          reset: 0xFF,            // 255
     */

    midi2call = function(midi_data, synth, only_channel) {
        only_channel = only_channel || -1;
        var firstByte = midi_data[0];
        var note = midi_data[1];
        var velocity = midi_data[2];
        if (firstByte < 0 || firstByte > 255) return; // invalid MIDI data
        var channel = firstByte & 15;
        var channelCommand = firstByte >> 4;

        if (only_channel > 0 && channel != only_channel) {
            return; // event on different channel
        }

        if (channelCommand == 8 || (channelCommand == 9 && velocity == 0) ) {
            synth.noteOff(note);
        } else if (channelCommand == 9) {
            synth.noteOn(note, velocity);
        } else if (channelCommand == 11  && synth.CC) {
            synth.CC(note, velocity);
        } else if (channelCommand == 12  && synth.programChange) {
            synth.programChange(note, velocity);
        } else if (channelCommand == 14  && synth.pitchBend) {
            var _14bit = velocity;
            _14bit <<= 7;
            _14bit |= note;
            synth.pitchBend((_14bit - 0x2000) / 0x2000);
        } else if (channelCommand == 0xb) {
            if (note == 0x78 || note == 0x7b) {
                synth.panic();
            } else if (note == 0x40) {
                // damper?
            }
        } else if (firstByte == 0x0f && synth.sysex) {
            synth.sysex(midi_data);
        } else if (firstByte == 0xfa && synth.start) {
            synth.start();
        } else if (firstByte == 0xfc && synth.stop) {
            synth.stop();
        }

    };

    dbgsyth = {
      noteOn : function (n, v) {
          console.log('note on', n, v);
      },
      noteOff : function (n, v) {
          console.log('note off', n);
      },
      panic : function () {
          console.log('PANIC!');
      },
      CC : function (note, velocity) {
          console.log('CC', note, velocity);
      },
      programChange : function (program) {
        console.log('programChange', program);
      },
      pitchBend : function (bend) {
        console.log('pitchBend', bend);
      },
      sysex : function (data) {
          console.log('sysex', data);

          if (data.length>8) {
              console.log('try parsing name:');
              console.log('preset no ', data[8]);
              console.log('name ', data.slice(8));
          }

      },
      start : function () {
          console.log('START!');
      },
      stop : function () {
          console.log('STOP!');
      }
    };


    ub.on("power","click",  function(ev){
        ub.stop(ev);
        ub.addClass("box_welcome", 'ub-hidden');
        ub.delClass("form", 'ub-hidden');

        ub.gebi('form').reset();
        hb.start();

        unoIn = JZZ().openMidiIn('UNO Synth').or('no uno');
        unoIn.and('uno ano!').connect(function(msg){ midi2call(msg, dbgsyth) });

        unoOut = JZZ().openMidiOut('UNO Synth').or('no uno out');
        unoOut.connect(function(msg){ midi2call(msg, dbgsyth) });

        // official test song for sequencers - Der Mussolini by DAF
        var notes = 'B2 E3 B2 D4 B2 B3 B2 B2 B3 B2 B3 B2 B3 A3 B2 B3'.split(' ');
        var lastNote = false;
        var notePos = 0;

        var octaveOffset = 12;

        var metro = Metro(function () {
            var note = notes[notePos];
            // hack transpose
           var msg = JZZ.MIDI.noteOn(0, note, 100);
           note = msg.getNote() + octaveOffset;

            if (lastNote) {
                unoOut.noteOff(0, lastNote);
            }
            unoOut.noteOn(0, note, 100);
            lastNote = note;
            notePos = ((notePos+ 1) % notes.length);
        });
        metro.setBpm(80);

        ub.on('play', 'click', function (ev) {
            ub.stop(ev);
            metro.start();
        });

        ub.on('stop', 'click', function (ev) {
            ub.stop(ev);
            metro.stop();
            unoOut.noteOff(0, lastNote);
            lastNote = false;
        });

        ub.on('octave_up', 'change', function () {
            octaveOffset = ub.gebi('octave_up').checked ? 24 : 12;
        });

        ub.on('preset', 'click', function (ev) {
            ub.stop(ev);
            console.log('tried sending MIDI');
            unoOut.send([0xf0, 0x00, 0x21, 0x1a, 0x02, 0x01, 0x31, 0xf7]); // get active preset
            unoOut.send([0xf0, 0x0, 0x21, 0x1a, 0x2, 0x1, 0x24, 0x1, 0x2c, 0xf7]); // get preset name
            console.log('done');
        });

    });
</script>

</body>
</html>
